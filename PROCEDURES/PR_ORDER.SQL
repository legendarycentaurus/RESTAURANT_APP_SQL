DELIMITER $$

CREATE  PROCEDURE `PR_ORDER`(IN I_SEATNO INT,IN I_ITEM_LIST MEDIUMTEXT,
IN I_QUANTITY_LIST MEDIUMTEXT,OUT O_MESSAGE TEXT)
BEGIN
          DECLARE NEXT_ITEM TEXT DEFAULT NULL ;
          DECLARE NEXT_QUANTITY TEXT DEFAULT NULL;
          DECLARE NEXT_QUANTITY_LENGTH INT DEFAULT NULL;
          DECLARE NEXT_ITEM_LENGTH INT DEFAULT NULL;
          DECLARE NEXT_ITEM_VALUE TEXT DEFAULT NULL;
          DECLARE CHECK_SEAT_VALUE TEXT;
          DECLARE NEXT_QUANTITY_VALUE TEXT DEFAULT NULL;
          DECLARE CHECK_QUANTITY TEXT;
          DECLARE CHECK_ITEM TEXT;
          DECLARE NO_OF_ITEMS INT DEFAULT 0;
          DECLARE MAX_LIMIT INT DEFAULT 0;
          SELECT FN_CHECK_SEAT(I_SEATNO) INTO CHECK_SEAT_VALUE;
          IF (CHECK_SEAT_VALUE) THEN 
      ##SET O_MESSAGE=CHECK_SEAT_VALUE;
    UPDATE HOTEL_SEATS SET STATUS=1 WHERE SEAT_NO=I_SEATNO; 
          SELECT FN_GENERATE_ORDER() INTO @ORDER_ID;
          SELECT MAX_ORDER INTO MAX_LIMIT FROM maximum_limit WHERE TYPE='weekday' ;
          ITERATOR :
         LOOP    
            IF LENGTH(TRIM(I_ITEM_LIST)) = 0 OR I_ITEM_LIST IS NULL  OR NO_OF_ITEMS>=MAX_LIMIT THEN
              LEAVE ITERATOR;
              END IF;
    SET NO_OF_ITEMS=NO_OF_ITEMS+1;
                 SET NEXT_ITEM = SUBSTRING_INDEX(I_ITEM_LIST,',',1);
                 SET NEXT_QUANTITY=SUBSTRING_INDEX(I_QUANTITY_LIST,',',1);
                 SET NEXT_ITEM_LENGTH = LENGTH(NEXT_ITEM);
                 SET NEXT_QUANTITY_LENGTH = LENGTH(NEXT_QUANTITY);
                 SET NEXT_ITEM_VALUE = TRIM(NEXT_ITEM);
                 SET NEXT_QUANTITY_VALUE= TRIM(NEXT_QUANTITY);
                 SELECT FN_CHECK_QUANTITY(NEXT_QUANTITY_VALUE)INTO CHECK_QUANTITY;
                SELECT FN_CHECK_ITEM(NEXT_ITEM_VALUE) INTO CHECK_ITEM;
                #IF (CHECK_SEAT_VALUE <> 'TRUE') THEN 
    # SET O_MESSAGE=CHECK_SEAT_VALUE;
                IF (CHECK_QUANTITY <> 'TRUE') THEN
      SET O_MESSAGE= CHECK_QUANTITY;
                ELSEIF (CHECK_ITEM <> 'TRUE')THEN
      SET O_MESSAGE=CHECK_ITEM; 
                ELSE
      CALL PR_PLACE_ORDER(NEXT_ITEM_VALUE,NEXT_QUANTITY_VALUE,I_SEATNO,@MESSAGE);
      SET O_MESSAGE=@MESSAGE;
      SELECT O_MESSAGE;            
                            END IF;      
                SET I_ITEM_LIST = INSERT(I_ITEM_LIST,1,NEXT_ITEM_LENGTH + 1,'');
                 SET I_QUANTITY_LIST = INSERT(I_QUANTITY_LIST,1,NEXT_QUANTITY_LENGTH + 1,'');
                
           END LOOP;   
           CALL PR_SHOW_BILL(@ORDER_ID,@MESSAGE,I_SEATNO);
           ELSE SET O_MESSAGE="Seat is occupied";
          END IF;
          
          
    END$$

DELIMITER ;